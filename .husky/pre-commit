#!/usr/bin/env bash

echo "[Hook] Git pre-commit hook started..."
echo "ğŸ“‚ [Info] Project root: $(pwd)"

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ ì €ì¥
PROJECT_ROOT=$(pwd)

# ìŠ¤í…Œì´ì§•ëœ ëª¨ë“  íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)
echo "[Info] Staged files detected:"
echo "$STAGED_FILES"

# í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ê²€ì‚¬ (í™•ì¥ì ì¶”ê°€: ts, tsx, js, jsx, vue, css, scss)
FE_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.((j|t)s(x)?|vue|css|scss)$' | grep "be15_DevEagles_FE" || true)
echo "[Debug] Frontend files found:"
echo "$FE_FILES"

# ìë°” íŒŒì¼ ê²€ì‚¬
JAVA_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.java$' | grep "be15_DevEagles_BE" || true)
echo "[Debug] Java files found:"
echo "$JAVA_FILES"

# í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°
if [ -n "$FE_FILES" ]; then
  echo "[INFO] ë³€ê²½ëœ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ê°ì§€ë¨"
  
  # í”„ë¡ íŠ¸ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
  echo "[Debug] Moving to frontend directory"
  cd "$PROJECT_ROOT/be15_DevEagles_FE" || { echo "âŒ [Error] Failed to change to frontend directory"; exit 1; }
  echo "[Debug] Current directory: $(pwd)"
  
  # package.jsonì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
  if [ ! -f "package.json" ]; then
    echo "âŒ [Error] package.json not found in $(pwd)"
    exit 1
  fi
  
  echo "[Action] lint-staged ì‹¤í–‰ ì¤‘..."
  # lint-stagedë¥¼ í†µí•´ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ë¦°íŒ… ì‹¤í–‰ (ë¹ˆ ì»¤ë°‹ í—ˆìš©)
  npx lint-staged --allow-empty || { echo "âŒ [Error] lint-staged failed"; exit 1; }
  
  # ë³€ê²½ëœ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ë‹¤ì‹œ ìŠ¤í…Œì´ì§•
  echo "[Action] Re-adding modified frontend files to staging..."
  cd "$PROJECT_ROOT" || exit 1
  for file in $FE_FILES; do
    if test -f "$file"; then
      echo "â• Adding: $file"
      git add "$file"
    fi
  done
  
  echo "âœ… [Success] Frontend linting completed."
fi

# ìë°” íŒŒì¼ ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ spotlessApply ì‹¤í–‰
if [ -n "$JAVA_FILES" ]; then
  echo "[INFO] ë³€ê²½ëœ ìë°” íŒŒì¼ ê°ì§€ë¨"
  
  # ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
  echo "[Debug] Moving to backend directory"
  cd "$PROJECT_ROOT/be15_DevEagles_BE" || { echo "âŒ [Error] Failed to change to backend directory"; exit 1; }
  echo "[Debug] Current directory: $(pwd)"
  
  # gradlew ì‹¤í–‰
  echo "[Action] Running spotlessApply for Java files..."
  if [ -f "gradlew.bat" ] && [ "$(uname)" = "Windows_NT" ]; then
    echo "[Debug] Using gradlew.bat"
    ./gradlew.bat spotlessApply --no-daemon
  elif [ -f "gradlew" ]; then
    echo "[Debug] Using gradlew"
    chmod +x ./gradlew
    ./gradlew spotlessApply --no-daemon
  else
    echo "âŒ [Error] Could not find gradlew or gradlew.bat in BE directory"
    exit 1
  fi
  
  SPOTLESS_RESULT=$?
  if [ $SPOTLESS_RESULT -ne 0 ]; then
    echo "âŒ [Error] spotlessApply failed! Error code: $SPOTLESS_RESULT"
    exit 1
  fi
  
  # ë³€ê²½ëœ ìë°” íŒŒì¼ ë‹¤ì‹œ ìŠ¤í…Œì´ì§•
  echo "[Action] Re-adding modified Java files to staging..."
  cd "$PROJECT_ROOT" || exit 1
  for file in $JAVA_FILES; do
    if test -f "$file"; then
      echo "â• Adding: $file"
      git add "$file"
    fi
  done
  
  echo "âœ… [Success] Java formatting completed."
fi

echo "âœ… [Hook] Pre-commit hook finished successfully."
